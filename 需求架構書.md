# 企業服務媒合平台需求架構書

## 一、專案概述

### 1.1 專案目標
建立一個企業服務媒合平台，提供企業服務上架、雙向評價、會員點數管理、訊息管理等核心功能，促進供需雙方媒合，提升服務品質與會員黏著度。

### 1.2 專案背景
參考 SUITE APP 平台模式，建立一個專業的企業服務媒合平台，讓企業服務提供者可以上架服務，企業使用者可以瀏覽、下單、評價服務，並透過點數系統與會員等級機制提升平台活躍度。

### 1.3 技術架構
- **前端框架**: Next.js 14+ (App Router)
- **後端服務**: Supabase (PostgreSQL, Auth, Storage, Realtime, Edge Functions)
- **部署平台**: Vercel (Next.js) + Supabase Cloud
- **樣式框架**: Tailwind CSS
- **開發語言**: TypeScript

---

## 二、系統架構模組

### 模組一：數據基礎與系統整合 (Data Foundation & System Integration)

#### 目標
- 建立單一、準確的會員主數據視圖
- 支援 360° 會員管理
- 提供統一的 API 閘道器

#### 核心功能

**1. 主數據管理 (MDM)**
- Supabase PostgreSQL 作為單一數據源
- 會員主檔管理（企業資訊、聯絡人、服務類別）
- 服務提供者主檔管理
- 數據同步與一致性保證

**2. Supabase 整合架構**
- **Supabase Auth**: 會員認證與授權（企業帳號、個人帳號）
- **Supabase Database**: 核心業務數據存儲
- **Supabase Storage**: 服務圖片、文件、證照上傳
- **Supabase Realtime**: 即時訊息、訂單狀態更新
- **Supabase Edge Functions**: 業務邏輯處理、第三方整合

**3. 數據模型設計**
- 會員表 (users, profiles)
- 企業服務表 (services, service_categories)
- 訂單表 (orders, order_items)
- 評價表 (reviews, ratings)
- 點數交易表 (points_transactions)
- 訊息表 (messages, conversations)

---

### 模組二：會員忠誠與數據輪廓引擎 (Loyalty & CRM Engine)

#### 目標
- 提升會員黏著度、貢獻度
- 提升續約率 (RR)
- 建立完整的會員數據輪廓

#### 核心功能

**1. 顧客 360 會員管理**
- 一鍵數位卡片啟用（快速註冊）
- 消費歷史大數據整合（服務訂單、活動參與、點數使用）
- 360° 受眾輪廓（以企業為中心）
- 會員標籤系統（Tagging）
  - 產品鏈標籤
  - 服務需求標籤
  - 消費能力標籤

**2. 會員等級系統 (Tiered Loyalty)**
- **策略目標**: 建立 VIP 品牌計劃，提升向上銷售
- **功能**:
  - 高效會員分級系統（基於消費金額、訂單數、評價分數）
  - 升級獎勵優化（點數/服務券）
  - 多元升級路徑（推薦新租戶/提供優質服務）
- **等級劃分**:
  - Bronze（銅級）：新註冊會員
  - Silver（銀級）：消費達 NT$ 50,000
  - Gold（黃金）：消費達 NT$ 200,000 或評價分數 4.5+
  - Platinum（白金）：消費達 NT$ 500,000 或評價分數 4.8+
  - VIP（尊榮）：消費達 NT$ 1,000,000 或評價分數 4.9+

**3. 會員點數系統 (Points Economy)**
- **策略目標**: 提升回購率與跨場域體驗 (CX)
- **功能**:
  - 全平台點數連通（累積與兌換）
  - 多元獎勵機制（消費點數/會員日加碼）
  - 點數兌換（會議室時數/合作夥伴折扣/服務券）
- **點數規則**:
  - 消費累點：每消費 NT$ 100 獲得 1 點
  - 評價獲點：完成評價獲得 50 點
  - 推薦獎勵：推薦新會員獲得 200 點
  - 升級獎勵：會員等級升級獲得額外點數

**技術實現**:
- Supabase Database: 點數交易記錄、會員等級規則
- Supabase Edge Functions: 點數計算邏輯、等級升級觸發
- Next.js API Routes: 點數查詢與兌換介面

---

### 模組三：資源市集與內容管理 (Marketplace & CMS)

#### 目標
- 建立清晰、易管理的企業服務型錄
- 促進供需雙方媒合

#### 核心功能

**1. 線上企業服務型錄 (CMS)**
- 快速上架/更新（自助管理）
- 分類新聞列表（依產業）
- 服務搜尋與篩選（類別、地區、評價、價格）
- 服務詳細頁（圖片、描述、提供者資訊、評價）

**2. 活動消息發佈系統**
- 活動建立與管理
- 活動報名與記錄
- 活動通知推送

**3. 輪播廣告管理**
- 首頁輪播圖管理
- 提升點擊率 (CTR)
- A/B 測試支援

**4. 服務類別**
- 財務會計
- 行銷推廣
- 法律諮詢
- 資訊科技
- 人力資源
- 設計創意

**技術實現**:
- Supabase Storage: 服務圖片、文件存儲
- Supabase Database: 服務資料、分類、標籤
- Next.js: 服務列表、搜尋、篩選頁面
- Supabase Full-text Search: 全文搜尋功能

---

### 模組四：服務互動與品質管理 (Interaction & Quality)

#### 目標
- 確保服務交易透明、可追蹤
- 建立信任與品質機制

#### 核心功能

**1. 服務提供者儀表板**
- 銷售數據展示（訂單數、收入、成長趨勢）
- 滿意度統計（平均評分、評價分布）
- 服務管理（上架、下架、編輯）

**2. 服務訂單動態通知**
- 訂單狀態追蹤（待確認、進行中、已完成、已取消）
- 即時狀態更新（Supabase Realtime）
- 訂單歷史記錄

**3. 互評與激勵機制（核心創新）**
- **提供者評分接收者**: 合作度評分
- **接收者評分提供者**: 專業度評分
- **評分連動機制**:
  - 觸發點數獎勵
  - 發放專屬優惠券
  - 影響會員等級

**4. 訂單狀態流程**
- **pending（待處理）**: 客戶下單，等待提供者確認
- **confirmed（已確認）**: 提供者確認訂單
- **in_progress（進行中）**: 服務執行中
- **completed（已完成）**: 服務完成，可進行評價
- **cancelled（已取消）**: 訂單取消

**技術實現**:
- Supabase Realtime: 訂單狀態即時更新
- Supabase Database: 評價表、評分規則
- Supabase Edge Functions: 評分觸發邏輯、點數發放

---

### 模組五：數據驅動與自動化行銷 (Automation & Retargeting)

#### 目標
- 降低溝通成本
- 精準觸發回購與升級

#### 核心功能

**1. 精準分眾分群再行銷系統**
- 聚合會員互動數據
- 分群標籤（RFM/NES 模型）
- 誘因再行銷（基於評分結果發放獎勵）
- 自動化排程腳本:
  - 即將降級會員通知
  - 非消費會員喚醒
  - VIP 升級祝賀
  - 自動提醒推播通知
- 精準分群推播通知（基於標籤結果）

**2. 互動通知與訊息匣系統 (Notification Hub)**
- CTA 連結（可追蹤流量引導）
- 訊息分類（系統通知、訂單通知、評價通知、點數通知）
- 訊息已讀/未讀狀態
- LBS 行動廣告（未來規劃）

**技術實現**:
- Supabase Database: 通知記錄、會員標籤
- Supabase Edge Functions: 自動化腳本、推播邏輯
- Supabase Realtime: 即時通知推送
- Next.js: 訊息匣 UI、通知中心

---

## 三、資料庫架構設計

### 3.1 核心資料表

#### users (Supabase Auth 擴展)
```sql
- id (uuid, PK)
- email (text, unique)
- role (text: provider, consumer, admin)
- created_at (timestamp)
- updated_at (timestamp)
```

#### profiles
```sql
- id (uuid, PK, FK → users.id)
- company_name (text)
- contact_person (text)
- phone (text)
- address (text)
- avatar_url (text)
- tier_level (text: bronze, silver, gold, platinum, vip)
- total_points (integer, default 0)
- tags (jsonb)
- created_at (timestamp)
- updated_at (timestamp)
```

#### services
```sql
- id (uuid, PK)
- provider_id (uuid, FK → profiles.id)
- title (text)
- description (text)
- category_id (uuid, FK → service_categories.id)
- price (integer)
- images (text[])
- status (text: active, inactive, pending)
- rating (numeric, default 0)
- review_count (integer, default 0)
- tags (text[])
- created_at (timestamp)
- updated_at (timestamp)
```

#### service_categories
```sql
- id (uuid, PK)
- name (text)
- icon (text)
- description (text)
- created_at (timestamp)
```

#### orders
```sql
- id (uuid, PK)
- consumer_id (uuid, FK → profiles.id)
- provider_id (uuid, FK → profiles.id)
- service_id (uuid, FK → services.id)
- status (text: pending, confirmed, in_progress, completed, cancelled)
- total_amount (integer)
- created_at (timestamp)
- updated_at (timestamp)
```

#### reviews
```sql
- id (uuid, PK)
- order_id (uuid, FK → orders.id)
- reviewer_id (uuid, FK → profiles.id)
- reviewee_id (uuid, FK → profiles.id)
- rating (integer, 1-5)
- comment (text)
- review_type (text: provider_to_consumer, consumer_to_provider)
- created_at (timestamp)
```

#### points_transactions
```sql
- id (uuid, PK)
- user_id (uuid, FK → profiles.id)
- amount (integer)
- transaction_type (text: earned, redeemed, expired)
- source (text: order, review, referral, upgrade)
- reference_id (uuid)
- description (text)
- created_at (timestamp)
```

#### messages
```sql
- id (uuid, PK)
- conversation_id (uuid, FK → conversations.id)
- sender_id (uuid, FK → profiles.id)
- content (text)
- read_at (timestamp, nullable)
- created_at (timestamp)
```

#### conversations
```sql
- id (uuid, PK)
- participant_1_id (uuid, FK → profiles.id)
- participant_2_id (uuid, FK → profiles.id)
- last_message_at (timestamp)
- created_at (timestamp)
```

#### notifications
```sql
- id (uuid, PK)
- user_id (uuid, FK → profiles.id)
- type (text: order, review, points, system)
- title (text)
- content (text)
- link (text)
- read_at (timestamp, nullable)
- created_at (timestamp)
```

### 3.2 索引與效能優化
- 服務搜尋索引（Full-text search）
- 訂單狀態索引
- 會員標籤 GIN 索引
- 點數交易時間索引
- 訊息對話索引

### 3.3 Row Level Security (RLS) 政策

**profiles 表**:
- 會員只能查看/編輯自己的資料
- 服務提供者可以查看客戶基本資訊（訂單相關）

**services 表**:
- 所有人可以查看 active 狀態的服務
- 服務提供者只能管理自己的服務

**orders 表**:
- 訂單參與者（consumer 和 provider）可以查看訂單
- 只有 consumer 可以建立訂單

**reviews 表**:
- 評價只能由訂單參與者建立
- 所有人可以查看已發佈的評價

**messages 表**:
- 只有對話參與者可以查看和發送訊息

---

## 四、API 設計

### 4.1 RESTful API (Next.js API Routes)

#### 服務相關
- `GET /api/services` - 取得服務列表（支援搜尋、篩選、分頁）
- `GET /api/services/[id]` - 取得服務詳情
- `POST /api/services` - 建立新服務（需 provider 權限）
- `PATCH /api/services/[id]` - 更新服務（需擁有者權限）
- `DELETE /api/services/[id]` - 刪除服務（需擁有者權限）

#### 訂單相關
- `GET /api/orders` - 取得訂單列表（依角色篩選）
- `GET /api/orders/[id]` - 取得訂單詳情
- `POST /api/orders` - 建立新訂單（需 consumer 權限）
- `PATCH /api/orders/[id]` - 更新訂單狀態（需參與者權限）

#### 評價相關
- `GET /api/reviews` - 取得評價列表
- `POST /api/reviews` - 建立新評價（需訂單參與者權限）
- `PATCH /api/reviews/[id]` - 更新評價（需擁有者權限）

#### 點數相關
- `GET /api/points` - 取得點數交易記錄
- `POST /api/points/redeem` - 兌換點數

#### 訊息相關
- `GET /api/messages` - 取得訊息列表
- `POST /api/messages` - 發送訊息
- `PATCH /api/messages/[id]/read` - 標記已讀

#### 通知相關
- `GET /api/notifications` - 取得通知列表
- `PATCH /api/notifications/[id]/read` - 標記已讀

### 4.2 Supabase Realtime Subscriptions
- 訂單狀態變更
- 新訊息通知
- 即時評價更新
- 點數交易通知

### 4.3 Supabase Edge Functions
- `calculate-points`: 點數計算與發放
- `upgrade-tier`: 會員等級升級邏輯
- `send-notification`: 自動化推播腳本
- `trigger-review-reward`: 評價觸發獎勵

---

## 五、前端頁面架構

### 5.1 公開頁面

#### 首頁 (`/`)
- Hero 區塊：平台介紹與 CTA
- 數據統計：註冊企業、服務提供者、平均評分等
- 熱門服務：展示 6 個熱門服務
- 平台特色：雙向評價、點數系統、會員等級
- 行動呼籲：引導註冊與探索服務

#### 服務市集 (`/services`)
- 服務搜尋與篩選
- 類別標籤切換
- 服務列表展示（卡片式）
- 分頁功能

#### 服務詳情 (`/services/[id]`)
- 服務詳細資訊
- 服務圖片輪播
- 服務提供者資訊卡片
- 客戶評價列表
- 立即下單與聯絡功能

#### 關於我們 (`/about`)
- 平台介紹
- 使命、願景、價值
- 平台特色說明

### 5.2 會員頁面

#### 儀表板 (`/dashboard`)
- 數據統計卡片（服務數、訂單數、點數、評分）
- 最近訂單列表
- 最近點數交易

#### 我的服務 (`/dashboard/services`)
- 服務統計（總數、服務中、審核中）
- 服務列表（表格形式）
- 新增、編輯、刪除服務
- 服務狀態管理

#### 訂單管理 (`/dashboard/orders`)
- 訂單統計（總數、各狀態數量）
- 訂單篩選（狀態、日期範圍）
- 訂單列表與狀態管理
- 訂單詳情查看

#### 評價管理 (`/dashboard/reviews`)
- 評價統計（總數、待評價、平均評分）
- 待評價訂單列表
- 所有評價列表（收到的/給出的）
- 評價篩選（評分、類型）

#### 點數中心 (`/dashboard/points`)
- 點數統計（總點數、本月獲得、可兌換項目）
- 點數規則說明
- 點數交易記錄
- 快速兌換功能

#### 訊息中心 (`/dashboard/messages`)
- 對話列表（側邊欄）
- 即時訊息介面
- 訊息搜尋
- 未讀訊息提示

#### 帳號設定 (`/dashboard/settings`)
- 基本資料編輯（姓名、公司、聯絡方式）
- 密碼變更
- 帳號資訊顯示（等級、點數、角色）

### 5.3 管理後台

#### 管理儀表板 (`/admin`)
- 系統總覽數據（會員數、服務數、訂單數、平均評分）
- 最近活動（新服務、新會員、新訂單、新評價）
- 快速操作（審核服務、管理會員、查看報表）

#### 服務審核 (`/admin/services`)
- 服務統計（總數、待審核、已通過、已拒絕）
- 服務列表與審核
- 通過/拒絕功能
- 服務詳情查看

#### 會員管理 (`/admin/users`)
- 會員統計（總數、提供者、使用者、VIP）
- 會員列表（表格形式）
- 會員搜尋與篩選（角色、等級）
- 會員詳情查看

#### 數據分析 (`/admin/analytics`)
- 營運數據指標（本月新增會員、服務、營收）
- 熱門服務排行
- 成長趨勢圖表（預留整合 Chart.js）
- 詳細統計（完成率、滿意度、平均週期）

#### 內容管理 (`/admin/content`)
- 首頁輪播圖管理（新增、編輯、刪除、排序）
- 公告消息管理（新增、編輯、發佈、下架）

#### 系統設定 (`/admin/settings`)
- 平台基本設定（名稱、描述、聯絡方式）
- 點數系統設定（累點比例、評價獲點、推薦獎勵）
- 系統資訊（版本、更新日期、資料庫狀態）

---

## 六、安全性與權限控制

### 6.1 Supabase Row Level Security (RLS)
- 會員只能查看/編輯自己的資料
- 服務提供者只能管理自己的服務
- 評價只能由訂單參與者建立
- 訊息只能由對話參與者查看

### 6.2 角色權限

#### consumer (服務使用者)
- 瀏覽服務
- 下單
- 評價服務提供者
- 使用點數
- 查看自己的訂單、評價、點數

#### provider (服務提供者)
- 上架服務
- 管理訂單
- 評價客戶
- 查看儀表板
- 管理自己的服務

#### admin (管理員)
- 全系統管理權限
- 服務審核
- 會員管理
- 數據分析
- 內容管理
- 系統設定

### 6.3 資料驗證
- 表單驗證（前端 + 後端）
- 圖片上傳限制（大小、格式）
- SQL Injection 防護（Supabase 自動處理）
- XSS 防護（Next.js 自動處理）

---

## 七、部署與維運

### 7.1 部署架構
- Next.js → Vercel
- Supabase → Supabase Cloud
- 環境變數管理（Vercel + Supabase）

### 7.2 環境變數
```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# App
NEXT_PUBLIC_APP_URL=
```

### 7.3 監控與日誌
- Vercel Analytics
- Supabase Logs
- 錯誤追蹤（Sentry 整合，未來規劃）

### 7.4 備份策略
- Supabase 自動備份（每日）
- 資料庫遷移版本控制

---

## 八、開發時程建議

### Phase 1: 基礎架構（2-3 週）
- Supabase 專案設定
- 資料庫架構建立
- Next.js 專案初始化
- 認證系統實作
- 基礎 UI 組件

### Phase 2: 核心功能（4-5 週）
- 服務市集（上架、瀏覽、搜尋）
- 訂單系統
- 評價系統
- 點數系統基礎

### Phase 3: 進階功能（3-4 週）
- 會員等級系統
- 訊息系統
- 通知系統
- 儀表板
- 後台管理

### Phase 4: 自動化與優化（2-3 週）
- 自動化行銷腳本
- 數據分析
- 效能優化
- 測試與除錯

---

## 九、參考文件格式

本文件參考 CBC ESRMS 系統設計範例的視覺風格：
- 使用清晰的模組分層架構
- 標示目標、策略目標、核心功能
- 使用顏色區分不同層級（目標、功能、詳細規格）
- 包含技術實現說明

---

## 十、附錄

### 10.1 名詞解釋
- **RFM 模型**: Recency（最近消費時間）、Frequency（消費頻率）、Monetary（消費金額）
- **NES 模型**: 會員分群模型
- **RLS**: Row Level Security，資料列層級安全性
- **MDM**: Master Data Management，主數據管理

### 10.2 相關文件
- Next.js 官方文件: https://nextjs.org/docs
- Supabase 官方文件: https://supabase.com/docs
- Tailwind CSS 文件: https://tailwindcss.com/docs

---

**文件版本**: v1.0  
**最後更新**: 2024-02-20  
**文件作者**: Dave App Store 開發團隊

